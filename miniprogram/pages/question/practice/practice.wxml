<!--pages/question/practice/practice.wxml-->
<view class="practice-page">
  <!-- é¡¶éƒ¨è¿›åº¦ -->
  <view class="progress-header">
    <view class="progress-info">
      <text class="current-num">{{currentIndex + 1}}</text>
      <text class="total-num">/{{questions.length}}</text>
    </view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{(currentIndex + 1) / questions.length * 100}}%"></view>
    </view>
    <view class="timer" wx:if="{{showTimer}}">
      <text class="timer-icon">â±</text>
      <text class="timer-text">{{timerText}}</text>
    </view>
  </view>

  <!-- é¢˜ç›®å†…å®¹ -->
  <swiper 
    class="question-swiper"
    current="{{currentIndex}}"
    bindchange="onSwiperChange"
    duration="200"
  >
    <swiper-item wx:for="{{questions}}" wx:key="id">
      <scroll-view class="question-scroll" scroll-y enhanced show-scrollbar="{{false}}">
        <view class="question-container">
          <!-- é¢˜ç›®ç±»å‹å’Œæ”¶è— -->
          <view class="question-meta">
            <view class="type-tag tag-{{item.type}}">{{item.typeText}}</view>
            <view class="difficulty-tag tag-difficulty-{{item.difficulty}}">{{item.difficultyText}}</view>
            <view class="favorite-btn" bindtap="toggleFavorite" data-index="{{index}}">
              <text class="favorite-icon {{item.isFavorite ? 'active' : ''}}">{{item.isFavorite ? 'â˜…' : 'â˜†'}}</text>
            </view>
          </view>

          <!-- é¢˜ç›®å†…å®¹ -->
          <view class="question-content">
            <text class="content-text">{{item.content}}</text>
          </view>

          <!-- é€‰é¡¹åˆ—è¡¨ -->
          <view class="options-list" wx:if="{{item.type === 1 || item.type === 2}}">
            <view 
              class="option-item {{item.userAnswer && item.userAnswer.includes(option.key) ? 'selected' : ''}} {{item.showAnswer && item.answer.includes(option.key) ? 'correct' : ''}} {{item.showAnswer && item.userAnswer && item.userAnswer.includes(option.key) && !item.answer.includes(option.key) ? 'wrong' : ''}}"
              wx:for="{{item.options}}"
              wx:for-item="option"
              wx:key="key"
              bindtap="selectOption"
              data-qindex="{{index}}"
              data-option="{{option.key}}"
            >
              <view class="option-key">{{option.key}}</view>
              <text class="option-text">{{option.value}}</text>
              <view class="option-status" wx:if="{{item.showAnswer}}">
                <text wx:if="{{item.answer.includes(option.key)}}">âœ“</text>
                <text wx:elif="{{item.userAnswer && item.userAnswer.includes(option.key)}}">âœ—</text>
              </view>
            </view>
          </view>

          <!-- åˆ¤æ–­é¢˜é€‰é¡¹ -->
          <view class="judge-options" wx:if="{{item.type === 3}}">
            <view 
              class="judge-item {{item.userAnswer === '1' ? 'selected' : ''}} {{item.showAnswer && item.answer === '1' ? 'correct' : ''}} {{item.showAnswer && item.userAnswer === '1' && item.answer !== '1' ? 'wrong' : ''}}"
              bindtap="selectJudge"
              data-qindex="{{index}}"
              data-answer="1"
            >
              <text class="judge-icon">âœ“</text>
              <text class="judge-text">æ­£ç¡®</text>
            </view>
            <view 
              class="judge-item {{item.userAnswer === '0' ? 'selected' : ''}} {{item.showAnswer && item.answer === '0' ? 'correct' : ''}} {{item.showAnswer && item.userAnswer === '0' && item.answer !== '0' ? 'wrong' : ''}}"
              bindtap="selectJudge"
              data-qindex="{{index}}"
              data-answer="0"
            >
              <text class="judge-icon">âœ—</text>
              <text class="judge-text">é”™è¯¯</text>
            </view>
          </view>

          <!-- å¤šé€‰é¢˜æäº¤æŒ‰é’® -->
          <view class="multi-submit" wx:if="{{item.type === 2 && !item.showAnswer}}">
            <button class="btn btn-primary" size="mini" bindtap="confirmMultiAnswer" data-index="{{index}}">ç¡®è®¤ç­”æ¡ˆ</button>
          </view>

          <!-- ç­”æ¡ˆè§£æ -->
          <view class="answer-section" wx:if="{{item.showAnswer}}">
            <view class="answer-header">
              <text class="answer-result {{item.isCorrect ? 'correct' : 'wrong'}}">{{item.isCorrect ? 'å›ç­”æ­£ç¡®' : 'å›ç­”é”™è¯¯'}}</text>
            </view>
            <view class="answer-box">
              <view class="answer-row">
                <text class="answer-label">æ­£ç¡®ç­”æ¡ˆï¼š</text>
                <text class="answer-value correct">{{item.answerText}}</text>
              </view>
              <view class="answer-row" wx:if="{{item.userAnswer}}">
                <text class="answer-label">ä½ çš„ç­”æ¡ˆï¼š</text>
                <text class="answer-value {{item.isCorrect ? 'correct' : 'wrong'}}">{{item.userAnswerText}}</text>
              </view>
            </view>
            <view class="analysis-box" wx:if="{{item.analysis}}">
              <text class="analysis-title">è§£æï¼š</text>
              <text class="analysis-content">{{item.analysis}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </swiper-item>
  </swiper>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="fixed-bottom action-bar">
    <view class="nav-btns">
      <button 
        class="nav-btn" 
        disabled="{{currentIndex === 0}}"
        bindtap="prevQuestion"
      >ä¸Šä¸€é¢˜</button>
      <button 
        class="nav-btn primary" 
        wx:if="{{currentIndex < questions.length - 1}}"
        bindtap="nextQuestion"
      >ä¸‹ä¸€é¢˜</button>
      <button 
        class="nav-btn primary" 
        wx:else
        bindtap="finishPractice"
      >å®Œæˆ</button>
    </view>
    <view class="answer-sheet-btn" bindtap="showAnswerSheet">
      <text class="sheet-icon">ğŸ“‹</text>
      <text class="sheet-text">ç­”é¢˜å¡</text>
    </view>
  </view>

  <!-- ç­”é¢˜å¡å¼¹çª— -->
  <view class="answer-sheet-modal" wx:if="{{showSheet}}" bindtap="hideAnswerSheet">
    <view class="sheet-content" catchtap="stopPropagation">
      <view class="sheet-header">
        <text class="sheet-title">ç­”é¢˜å¡</text>
        <text class="sheet-close" bindtap="hideAnswerSheet">Ã—</text>
      </view>
      <view class="sheet-stats">
        <text class="stat-item">å·²ç­”ï¼š{{answeredCount}}</text>
        <text class="stat-item">æœªç­”ï¼š{{questions.length - answeredCount}}</text>
        <text class="stat-item" wx:if="{{showAnswerStats}}">æ­£ç¡®ï¼š{{correctCount}}</text>
      </view>
      <view class="sheet-grid">
        <view 
          class="sheet-item {{item.userAnswer ? 'answered' : ''}} {{item.showAnswer ? (item.isCorrect ? 'correct' : 'wrong') : ''}}"
          wx:for="{{questions}}"
          wx:key="id"
          bindtap="jumpToQuestion"
          data-index="{{index}}"
        >{{index + 1}}</view>
      </view>
    </view>
  </view>
</view>
